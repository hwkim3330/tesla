<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tesla FSD - Architecture</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .hero {
            height: 50vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0f 70%);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233e6ae1' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 200;
            margin-bottom: 15px;
            z-index: 1;
        }

        .hero p {
            font-size: 1.2rem;
            color: #888;
            z-index: 1;
        }

        /* Pipeline Diagram */
        .pipeline {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 40px;
        }

        .pipeline-stage {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .pipeline-node {
            flex: 1;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pipeline-node:hover {
            transform: scale(1.02);
        }

        .pipeline-node.input {
            background: linear-gradient(135deg, #1a3a5c, #0d1f2d);
            border: 2px solid var(--tesla-blue);
        }

        .pipeline-node.backbone {
            background: linear-gradient(135deg, #2d1a4e, #1a0d2e);
            border: 2px solid var(--tesla-purple);
        }

        .pipeline-node.transformer {
            background: linear-gradient(135deg, #1a4a3a, #0d2e1f);
            border: 2px solid var(--tesla-green);
        }

        .pipeline-node.output {
            background: linear-gradient(135deg, #4a1a1a, #2e0d0d);
            border: 2px solid var(--tesla-red);
        }

        .pipeline-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .pipeline-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .pipeline-desc {
            font-size: 0.85rem;
            color: #888;
        }

        .pipeline-arrow {
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }

        .pipeline-arrow svg {
            width: 30px;
            height: 30px;
            fill: #444;
        }

        /* Layer Detail */
        .layer-detail {
            background: rgba(0,0,0,0.5);
            border-radius: 16px;
            padding: 30px;
            margin-top: 40px;
        }

        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .layer-item {
            background: rgba(255,255,255,0.03);
            padding: 20px;
            border-radius: 10px;
            border-left: 3px solid var(--tesla-blue);
        }

        .layer-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .layer-params {
            font-size: 0.85rem;
            color: #666;
        }

        /* Code Block */
        .code-block {
            background: #0d0d12;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            overflow-x: auto;
            border: 1px solid #222;
        }

        .code-comment { color: #6a9955; }
        .code-keyword { color: #569cd6; }
        .code-string { color: #ce9178; }
        .code-number { color: #b5cea8; }
        .code-class { color: #4ec9b0; }

        /* Interactive Diagram */
        .interactive-diagram {
            position: relative;
            height: 600px;
            background: rgba(0,0,0,0.5);
            border-radius: 16px;
            overflow: hidden;
        }

        #arch-canvas {
            width: 100%;
            height: 100%;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .tab.active {
            background: var(--tesla-blue);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <a href="index.html" class="nav-logo">TESLA <span>FSD</span></a>
        <div class="nav-links">
            <a href="index.html" class="nav-link">Autopilot</a>
            <a href="dashboard.html" class="nav-link">Dashboard</a>
            <a href="architecture.html" class="nav-link active">Architecture</a>
            <a href="hardware.html" class="nav-link">HW4/HW5</a>
            <a href="cameras.html" class="nav-link">8 Cameras</a>
            <a href="versions.html" class="nav-link">V12‚ÜíV15</a>
            <a href="demo.html" class="nav-link">Live Demo</a>
        </div>
        <div class="nav-badge">V12 End-to-End</div>
    </nav>

    <main class="main-content">
        <!-- Hero -->
        <section class="hero">
            <h1>Neural Network Architecture</h1>
            <p>End-to-End: Photons In, Control Out</p>
        </section>

        <!-- Architecture Tabs -->
        <section class="section">
            <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="backbone">Backbone</button>
                <button class="tab" data-tab="transformer">Transformer</button>
                <button class="tab" data-tab="heads">Task Heads</button>
                <button class="tab" data-tab="code">Code</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="tab-overview">
                <div class="pipeline">
                    <!-- Input Layer -->
                    <div class="pipeline-stage">
                        <div class="pipeline-node input">
                            <div class="pipeline-icon">üìπ</div>
                            <div class="pipeline-title">8 Cameras</div>
                            <div class="pipeline-desc">1280x960 @ 36fps</div>
                        </div>
                        <div class="pipeline-node input">
                            <div class="pipeline-icon">üó∫Ô∏è</div>
                            <div class="pipeline-title">Navigation</div>
                            <div class="pipeline-desc">Route & Destination</div>
                        </div>
                        <div class="pipeline-node input">
                            <div class="pipeline-icon">üìä</div>
                            <div class="pipeline-title">Vehicle State</div>
                            <div class="pipeline-desc">Speed, IMU, CAN</div>
                        </div>
                    </div>

                    <div class="pipeline-arrow">
                        <svg viewBox="0 0 24 24"><path d="M12 4v16m-6-6l6 6 6-6"/></svg>
                    </div>

                    <!-- Backbone -->
                    <div class="pipeline-stage">
                        <div class="pipeline-node backbone" style="flex: 2;">
                            <div class="pipeline-icon">üîç</div>
                            <div class="pipeline-title">RegNet Backbone + FPN</div>
                            <div class="pipeline-desc">Multi-scale feature extraction with Squeeze-Excitation blocks</div>
                        </div>
                    </div>

                    <div class="pipeline-arrow">
                        <svg viewBox="0 0 24 24"><path d="M12 4v16m-6-6l6 6 6-6"/></svg>
                    </div>

                    <!-- Temporal + Transformer -->
                    <div class="pipeline-stage">
                        <div class="pipeline-node backbone">
                            <div class="pipeline-icon">‚è±Ô∏è</div>
                            <div class="pipeline-title">Temporal Module</div>
                            <div class="pipeline-desc">Video memory & motion</div>
                        </div>
                        <div class="pipeline-node transformer">
                            <div class="pipeline-icon">üß†</div>
                            <div class="pipeline-title">BEV Transformer</div>
                            <div class="pipeline-desc">2D‚Üí3D projection</div>
                        </div>
                        <div class="pipeline-node transformer">
                            <div class="pipeline-icon">üåç</div>
                            <div class="pipeline-title">World Model</div>
                            <div class="pipeline-desc">Future prediction</div>
                        </div>
                    </div>

                    <div class="pipeline-arrow">
                        <svg viewBox="0 0 24 24"><path d="M12 4v16m-6-6l6 6 6-6"/></svg>
                    </div>

                    <!-- Task Heads -->
                    <div class="pipeline-stage">
                        <div class="pipeline-node transformer">
                            <div class="pipeline-icon">üöó</div>
                            <div class="pipeline-title">Detection</div>
                            <div class="pipeline-desc">3D objects</div>
                        </div>
                        <div class="pipeline-node transformer">
                            <div class="pipeline-icon">üõ£Ô∏è</div>
                            <div class="pipeline-title">Lanes</div>
                            <div class="pipeline-desc">Lane topology</div>
                        </div>
                        <div class="pipeline-node transformer">
                            <div class="pipeline-icon">üìê</div>
                            <div class="pipeline-title">Depth</div>
                            <div class="pipeline-desc">Dense depth</div>
                        </div>
                        <div class="pipeline-node transformer">
                            <div class="pipeline-icon">üó∫Ô∏è</div>
                            <div class="pipeline-title">Occupancy</div>
                            <div class="pipeline-desc">3D voxels</div>
                        </div>
                    </div>

                    <div class="pipeline-arrow">
                        <svg viewBox="0 0 24 24"><path d="M12 4v16m-6-6l6 6 6-6"/></svg>
                    </div>

                    <!-- Output -->
                    <div class="pipeline-stage">
                        <div class="pipeline-node output">
                            <div class="pipeline-icon">üõ§Ô∏è</div>
                            <div class="pipeline-title">Trajectory</div>
                            <div class="pipeline-desc">Future path</div>
                        </div>
                        <div class="pipeline-node output">
                            <div class="pipeline-icon">üéÆ</div>
                            <div class="pipeline-title">Control</div>
                            <div class="pipeline-desc">Steering, Accel, Brake</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backbone Tab -->
            <div class="tab-content" id="tab-backbone">
                <h3 style="margin-bottom: 20px;">RegNet Backbone with Feature Pyramid Network</h3>
                <p style="color: #888; margin-bottom: 30px;">
                    The backbone extracts hierarchical features from input images using RegNet architecture
                    with Squeeze-Excitation blocks for channel attention.
                </p>

                <div class="layer-detail">
                    <h4>Network Layers</h4>
                    <div class="layer-grid">
                        <div class="layer-item">
                            <div class="layer-name">Stem</div>
                            <div class="layer-params">Conv 3x3, stride 2 ‚Üí 32 channels</div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-name">Stage 1</div>
                            <div class="layer-params">2 blocks ‚Üí 64 channels, /2</div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-name">Stage 2</div>
                            <div class="layer-params">4 blocks ‚Üí 128 channels, /2</div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-name">Stage 3</div>
                            <div class="layer-params">10 blocks ‚Üí 256 channels, /2</div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-name">Stage 4</div>
                            <div class="layer-params">2 blocks ‚Üí 512 channels, /2</div>
                        </div>
                        <div class="layer-item">
                            <div class="layer-name">FPN</div>
                            <div class="layer-params">Multi-scale fusion ‚Üí 256 channels</div>
                        </div>
                    </div>
                </div>

                <div class="grid-3" style="margin-top: 30px;">
                    <div class="stat-box card">
                        <div class="stat-value">~50M</div>
                        <div class="stat-label">Backbone Parameters</div>
                    </div>
                    <div class="stat-box card">
                        <div class="stat-value">5</div>
                        <div class="stat-label">Feature Scales</div>
                    </div>
                    <div class="stat-box card">
                        <div class="stat-value">256</div>
                        <div class="stat-label">FPN Channels</div>
                    </div>
                </div>
            </div>

            <!-- Transformer Tab -->
            <div class="tab-content" id="tab-transformer">
                <h3 style="margin-bottom: 20px;">BEV Transformer & Attention Mechanism</h3>
                <p style="color: #888; margin-bottom: 30px;">
                    Transforms 2D image features into a unified 3D Bird's Eye View representation
                    using deformable cross-attention.
                </p>

                <div class="interactive-diagram">
                    <canvas id="arch-canvas"></canvas>
                </div>

                <div class="grid-2" style="margin-top: 30px;">
                    <div class="card">
                        <h4 style="margin-bottom: 15px;">Cross-Attention</h4>
                        <p style="color: #888; font-size: 0.9rem; line-height: 1.6;">
                            BEV queries attend to 2D image features through deformable attention.
                            Each 3D query point is projected to multiple camera views to gather features.
                        </p>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 15px;">Temporal Fusion</h4>
                        <p style="color: #888; font-size: 0.9rem; line-height: 1.6;">
                            Historical BEV features are warped using ego-motion and fused with
                            current features for temporal consistency.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Task Heads Tab -->
            <div class="tab-content" id="tab-heads">
                <h3 style="margin-bottom: 20px;">HydraNet Multi-Task Heads</h3>
                <p style="color: #888; margin-bottom: 30px;">
                    Single shared backbone with multiple task-specific heads for efficient multi-task learning.
                </p>

                <div class="grid-2">
                    <div class="card" style="border-left: 4px solid var(--tesla-blue);">
                        <div class="card-icon">üöó</div>
                        <div class="card-title">Object Detection</div>
                        <p style="color: #888; font-size: 0.9rem;">
                            3D bounding boxes with class, position, dimensions, velocity, and heading.
                            Classes: vehicles, pedestrians, cyclists, traffic cones.
                        </p>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--tesla-green);">
                        <div class="card-icon">üõ£Ô∏è</div>
                        <div class="card-title">Lane Detection</div>
                        <p style="color: #888; font-size: 0.9rem;">
                            Lane line geometry with type classification (solid, dashed, double).
                            Includes lane connectivity and topology.
                        </p>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--tesla-purple);">
                        <div class="card-icon">üìê</div>
                        <div class="card-title">Depth Estimation</div>
                        <p style="color: #888; font-size: 0.9rem;">
                            Dense depth prediction for each camera view.
                            Self-supervised learning from video sequences.
                        </p>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--tesla-yellow);">
                        <div class="card-icon">üé®</div>
                        <div class="card-title">Semantic Segmentation</div>
                        <p style="color: #888; font-size: 0.9rem;">
                            Per-pixel classification: road, sidewalk, building, vegetation, sky, vehicle, pedestrian.
                        </p>
                    </div>
                    <div class="card" style="border-left: 4px solid var(--tesla-red);">
                        <div class="card-icon">üö¶</div>
                        <div class="card-title">Traffic Light Detection</div>
                        <p style="color: #888; font-size: 0.9rem;">
                            Traffic light detection with state classification (red, yellow, green, off)
                            and relevance determination.
                        </p>
                    </div>
                    <div class="card" style="border-left: 4px solid #17b06b;">
                        <div class="card-icon">üõ§Ô∏è</div>
                        <div class="card-title">Path Prediction</div>
                        <p style="color: #888; font-size: 0.9rem;">
                            Future trajectory prediction with multiple modes and confidence scores.
                            10-second horizon with 0.5-second steps.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Code Tab -->
            <div class="tab-content" id="tab-code">
                <h3 style="margin-bottom: 20px;">PyTorch Implementation</h3>

                <div class="code-block">
                    <pre><span class="code-keyword">class</span> <span class="code-class">TeslaFSDVision</span>(nn.Module):
    <span class="code-comment">"""Complete Tesla FSD Vision System"""</span>

    <span class="code-keyword">def</span> <span class="code-keyword">__init__</span>(self, config):
        <span class="code-keyword">super</span>().__init__()

        <span class="code-comment"># RegNet backbone with FPN</span>
        self.backbone = RegNetBackbone(
            depths=[<span class="code-number">2</span>, <span class="code-number">4</span>, <span class="code-number">10</span>, <span class="code-number">2</span>],
            channels=[<span class="code-number">64</span>, <span class="code-number">128</span>, <span class="code-number">256</span>, <span class="code-number">512</span>],
            use_se=<span class="code-keyword">True</span>
        )

        <span class="code-comment"># BEV Transformer for 2D ‚Üí 3D</span>
        self.bev_transformer = BEVTransformer(
            bev_size=(<span class="code-number">200</span>, <span class="code-number">200</span>),
            num_layers=<span class="code-number">6</span>,
            num_heads=<span class="code-number">8</span>
        )

        <span class="code-comment"># Multi-task heads (HydraNet)</span>
        self.hydranet = HydraNet(
            backbone_channels=<span class="code-number">256</span>,
            tasks=[<span class="code-string">'detection'</span>, <span class="code-string">'lanes'</span>, <span class="code-string">'depth'</span>, <span class="code-string">'segmentation'</span>]
        )

        <span class="code-comment"># Occupancy network for 3D scene</span>
        self.occupancy = OccupancyNetwork(
            voxel_size=(<span class="code-number">200</span>, <span class="code-number">200</span>, <span class="code-number">16</span>),
            num_classes=<span class="code-number">16</span>
        )

    <span class="code-keyword">def</span> forward(self, images, intrinsics, extrinsics):
        <span class="code-comment"># Extract multi-scale features</span>
        features = self.backbone(images)

        <span class="code-comment"># Transform to BEV</span>
        bev_features = self.bev_transformer(
            features, intrinsics, extrinsics
        )

        <span class="code-comment"># Multi-task predictions</span>
        outputs = self.hydranet(bev_features)

        <span class="code-comment"># 3D occupancy</span>
        outputs[<span class="code-string">'occupancy'</span>] = self.occupancy(bev_features)

        <span class="code-keyword">return</span> outputs</pre>
                </div>

                <div style="margin-top: 20px;">
                    <a href="https://github.com/hwkim3330/tesla/tree/main/python" class="btn btn-primary">
                        View Full Code on GitHub
                    </a>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="section" style="background: var(--tesla-gray);">
            <div class="section-header">
                <h2 class="section-title">Network Statistics</h2>
            </div>
            <div class="grid-4">
                <div class="stat-box card glow-blue">
                    <div class="stat-value">1.2B</div>
                    <div class="stat-label">Total Parameters</div>
                </div>
                <div class="stat-box card">
                    <div class="stat-value">~100</div>
                    <div class="stat-label">TFLOPS</div>
                </div>
                <div class="stat-box card">
                    <div class="stat-value">50ms</div>
                    <div class="stat-label">Inference Time</div>
                </div>
                <div class="stat-box card">
                    <div class="stat-value">8</div>
                    <div class="stat-label">Camera Inputs</div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>Educational visualization of Tesla FSD architecture. Not affiliated with Tesla, Inc.</p>
        <p><a href="https://github.com/hwkim3330/tesla">View on GitHub</a></p>
    </footer>

    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Architecture canvas animation
        const canvas = document.getElementById('arch-canvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');

            function resize() {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            let time = 0;
            const nodes = [];
            const connections = [];

            // Create transformer attention visualization
            for (let i = 0; i < 50; i++) {
                nodes.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: 3 + Math.random() * 4,
                    type: Math.random() > 0.5 ? 'query' : 'key'
                });
            }

            function animate() {
                time += 0.016;

                ctx.fillStyle = 'rgba(10, 10, 15, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Update and draw nodes
                nodes.forEach((node, i) => {
                    node.x += node.vx;
                    node.y += node.vy;

                    if (node.x < 0 || node.x > canvas.width) node.vx *= -1;
                    if (node.y < 0 || node.y > canvas.height) node.vy *= -1;

                    // Draw attention connections
                    nodes.forEach((other, j) => {
                        if (i >= j) return;
                        const dx = other.x - node.x;
                        const dy = other.y - node.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < 100) {
                            const alpha = (1 - dist / 100) * 0.3;
                            ctx.strokeStyle = node.type === 'query'
                                ? `rgba(62, 106, 225, ${alpha})`
                                : `rgba(23, 176, 107, ${alpha})`;
                            ctx.lineWidth = 1;
                            ctx.beginPath();
                            ctx.moveTo(node.x, node.y);
                            ctx.lineTo(other.x, other.y);
                            ctx.stroke();
                        }
                    });

                    // Draw node
                    const gradient = ctx.createRadialGradient(
                        node.x, node.y, 0,
                        node.x, node.y, node.size * 2
                    );
                    const color = node.type === 'query' ? '#3e6ae1' : '#17b06b';
                    gradient.addColorStop(0, color);
                    gradient.addColorStop(1, 'transparent');

                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(node.x, node.y, node.size * 2, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Labels
                ctx.fillStyle = '#666';
                ctx.font = '12px sans-serif';
                ctx.fillText('Query Tokens (Blue) ‚Üê Cross-Attention ‚Üí Key Tokens (Green)', 20, 30);

                requestAnimationFrame(animate);
            }
            animate();
        }
    </script>
</body>
</html>
