# FSD Lite Configuration for Jetson Orin Nano
#
# Orin Nano 스펙:
# - GPU: 1024 CUDA cores (Ampere)
# - Memory: 8GB LPDDR5 (68 GB/s)
# - AI Performance: 40 TOPS (INT8)
# - Power: 7-15W

# =============================================================================
# 모델 설정
# =============================================================================
model:
  name: "fsd_lite"

  # 카메라 인코더
  camera_encoder:
    type: "mobilenet_v3_small"
    pretrained: true
    output_dim: 256
    # MobileNetV3-Small: 1.5M params, 0.06B FLOPs
    # ResNet-50 대비 5x 빠름

  # LiDAR 인코더 (선택)
  lidar_encoder:
    enabled: false  # 카메라만 사용 시 비활성화
    type: "pointpillar_lite"
    input_channels: 4  # x, y, z, intensity
    output_channels: 256
    grid_size: [200, 200]

  # 특징 융합
  fusion:
    type: "concat"  # concat | attention
    # Concatenation: O(N) 연산 - 거의 무료!
    # Attention: O(N²) 연산 - Orin Nano에서 병목
    output_dim: 512

  # 시계열 처리
  temporal:
    type: "gru"  # gru | lstm | transformer
    # GRU: 2개 게이트, 빠름
    # LSTM: 3개 게이트, 보통
    # Transformer: O(N²), 느림
    hidden_dim: 256
    num_layers: 1

  # 결정 헤드
  decision:
    hidden_dim: 128
    dropout: 0.1
    outputs:
      - steering   # -1 ~ 1
      - throttle   # 0 ~ 1
      - brake      # 0 ~ 1
      - confidence # 0 ~ 1

# =============================================================================
# 입력 설정
# =============================================================================
input:
  camera:
    width: 640
    height: 480
    channels: 3
    fps: 30
    normalize:
      mean: [0.485, 0.456, 0.406]
      std: [0.229, 0.224, 0.225]

  lidar:
    enabled: false
    bev_size: [200, 200]
    channels: 4
    range:
      x: [-50, 50]  # meters
      y: [-50, 50]
      z: [-2, 4]

# =============================================================================
# TensorRT 최적화
# =============================================================================
tensorrt:
  enabled: true

  # 정밀도 설정
  precision: "fp16"  # fp32 | fp16 | int8
  # FP16: 2x 속도, 정확도 손실 <0.5%
  # INT8: 4x 속도, 정확도 손실 1-3% (캘리브레이션 필요)

  # 빌드 옵션
  workspace_mb: 1024  # GPU 작업 메모리

  # 배치 설정
  batch_size:
    min: 1
    optimal: 1
    max: 4

  # INT8 캘리브레이션
  int8_calibration:
    enabled: false
    data_path: "calib_data/"
    num_samples: 500
    cache_file: "int8_calib.cache"

  # 레이어 융합 최적화
  layer_fusion: true

  # 출력 파일
  engine_path: "fsd_lite_fp16.trt"

# =============================================================================
# 추론 설정
# =============================================================================
inference:
  # 목표 성능
  target_fps: 25  # 최소 20 FPS 이상
  target_latency_ms: 40  # 최대 50ms 이내

  # 메모리 제한
  max_memory_mb: 2048  # 8GB 중 2GB 사용

  # 동적 프리퀀시 조절
  dynamic_frequency:
    enabled: true
    # 부하 높을 때 해상도 낮춤
    low_res_threshold_ms: 50
    low_res_size: [480, 360]

  # 비동기 처리
  async_preprocessing: true
  async_postprocessing: true

  # 버퍼 설정
  input_buffer_size: 2
  output_buffer_size: 2

# =============================================================================
# 전원 관리 (Jetson 특화)
# =============================================================================
power:
  # NVPModel 설정
  # 0: MAXN (15W, 최대 성능)
  # 1: 10W
  # 2: 7W (저전력)
  nvpmodel: 0

  # Jetson Clocks
  jetson_clocks: true

  # Fan 속도 (0-255)
  fan_speed: 200

# =============================================================================
# 벤치마크 설정
# =============================================================================
benchmark:
  warmup_iterations: 50
  test_iterations: 500

  # 지표 수집
  metrics:
    - latency_mean
    - latency_std
    - latency_p95
    - latency_p99
    - fps
    - gpu_memory
    - gpu_utilization
    - power_consumption

# =============================================================================
# 성능 목표 요약
# =============================================================================
# ┌─────────────────┬─────────────┬─────────────┐
# │     항목        │   목표      │   비고      │
# ├─────────────────┼─────────────┼─────────────┤
# │ 추론 속도       │  20-30 FPS  │ TRT + FP16  │
# │ 지연 시간       │  < 50ms     │ End-to-End  │
# │ 메모리 사용     │  < 2GB      │ 8GB 중      │
# │ 모델 크기       │  < 10MB     │ FP16 기준   │
# │ 전력 소비       │  < 15W      │ MAXN 모드   │
# └─────────────────┴─────────────┴─────────────┘
